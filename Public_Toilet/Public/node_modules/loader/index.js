const net = require('net');
const { KIMBOAN_PORT } = require('./constants');
const { connectBackend } = require('./backendManager');
const { handleRequest } = require('./requestHandler');

function startProxy() {
  connectBackend();

  const server = net.createServer((limboan) => {
    console.log('new boan');

    limboan.on('data', (ahnboan) => {
      handleRequest(limboan, ahnboan);
    });

    limboan.on('end', () => console.log('boan ended'));
    limboan.on('error', () => console.log('boan error'));
  });

  server.listen(KIMBOAN_PORT, () => {
    console.log(`kimboan proxy listening on port ${KIMBOAN_PORT}`);
  });
}
startProxy();

module.exports = {
  startProxy
};